<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest Hand Tracking - Simple Version</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #222;
            color: white;
            text-align: center;
        }
        button {
            background: #4CAF50;
            border: none;
            color: white;
            padding: 20px 40px;
            font-size: 18px;
            margin: 10px;
            cursor: pointer;
            border-radius: 10px;
        }
        .status {
            font-size: 24px;
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
        }
        .data {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-family: monospace;
            text-align: left;
        }
    </style>
</head>
<body>
    <h1>ğŸ¤– Quest Hand Tracking - Simple</h1>
    
    <div id="status" class="status">
        çŠ¶æ€: å‡†å¤‡å°±ç»ª
    </div>
    
    <button onclick="startSimpleTracking()">å¼€å§‹ç®€å•è¿½è¸ª</button>
    <button onclick="enterVR()" style="background: #2196F3;">è¿›å…¥VRæ¨¡å¼</button>
    
    <div class="data">
        <h3>ğŸ“¡ æ‰‹éƒ¨æ•°æ®</h3>
        <div id="dataOutput">ç­‰å¾…å¼€å§‹...</div>
    </div>
    
    <div style="margin-top: 30px; font-size: 14px;">
        <p>ğŸ”§ è°ƒè¯•æ¨¡å¼è¯´æ˜:</p>
        <ul style="text-align: left; max-width: 600px; margin: 0 auto;">
            <li><strong>ç®€å•è¿½è¸ª:</strong> å‘é€æ¨¡æ‹Ÿæ•°æ®è¿›è¡Œæµ‹è¯•</li>
            <li><strong>VRæ¨¡å¼:</strong> å°è¯•å¯åŠ¨çœŸå®çš„æ‰‹éƒ¨è¿½è¸ª</li>
            <li>ç¡®ä¿WebSocketæœåŠ¡å™¨è¿è¡Œåœ¨: ws://10.3.32.31:8765</li>
        </ul>
    </div>

    <script>
        let websocket = null;
        let isTracking = false;
        let trackingInterval = null;

        // WebSocketè¿æ¥
        function connectWebSocket() {
            try {
                websocket = new WebSocket('ws://10.3.32.31:8765');
                
                websocket.onopen = function() {
                    updateStatus('âœ… å·²è¿æ¥åˆ°æœºæ¢°è‡‚æ§åˆ¶æœåŠ¡å™¨');
                    updateData('WebSocketè¿æ¥æˆåŠŸ');
                };
                
                websocket.onclose = function() {
                    updateStatus('âŒ ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥');
                    updateData('WebSocketè¿æ¥æ–­å¼€');
                };
                
                websocket.onerror = function(error) {
                    updateStatus('âŒ è¿æ¥é”™è¯¯');
                    updateData('WebSocketè¿æ¥é”™è¯¯: ' + error);
                };
                
            } catch (error) {
                updateStatus('âŒ WebSocketè¿æ¥å¤±è´¥');
                updateData('è¿æ¥å¤±è´¥: ' + error);
            }
        }

        // ç®€å•è¿½è¸ª (å‘é€æµ‹è¯•æ•°æ®)
        function startSimpleTracking() {
            if (isTracking) {
                stopTracking();
                return;
            }
            
            connectWebSocket();
            isTracking = true;
            
            updateStatus('ğŸ”„ ç®€å•è¿½è¸ªæ¨¡å¼è¿è¡Œä¸­...');
            
            // æ¨¡æ‹Ÿæ‰‹éƒ¨æ•°æ®å‘é€
            trackingInterval = setInterval(() => {
                if (websocket && websocket.readyState === WebSocket.OPEN) {
                    const time = Date.now() / 1000;
                    
                    // ç”Ÿæˆæ¨¡æ‹Ÿçš„æ‰‹éƒ¨è¿½è¸ªæ•°æ®
                    const handData = {
                        timestamp: time,
                        leftHand: {
                            isTracked: true,
                            position: {
                                x: -0.2 + 0.1 * Math.sin(time * 0.5),
                                y: 0.1 + 0.05 * Math.cos(time * 0.7),
                                z: -0.3 + 0.03 * Math.sin(time * 0.3)
                            },
                            rotation: {
                                x: 0, y: 0, z: 0, w: 1
                            },
                            pinchStrength: (Math.sin(time * 2) + 1) / 4
                        },
                        rightHand: {
                            isTracked: true,
                            position: {
                                x: 0.2 + 0.1 * Math.sin(time * 0.5 + Math.PI),
                                y: 0.1 + 0.05 * Math.cos(time * 0.7 + Math.PI),
                                z: -0.3 + 0.03 * Math.sin(time * 0.3 + Math.PI)
                            },
                            rotation: {
                                x: 0, y: 0, z: 0, w: 1
                            },
                            pinchStrength: (Math.sin(time * 2 + Math.PI) + 1) / 4
                        }
                    };
                    
                    websocket.send(JSON.stringify(handData));
                    
                    // æ›´æ–°æ˜¾ç¤º
                    updateData(`å‘é€æ•°æ®: å·¦æ‰‹(${handData.leftHand.position.x.toFixed(2)}, ${handData.leftHand.position.y.toFixed(2)}, ${handData.leftHand.position.z.toFixed(2)}) å³æ‰‹(${handData.rightHand.position.x.toFixed(2)}, ${handData.rightHand.position.y.toFixed(2)}, ${handData.rightHand.position.z.toFixed(2)})`);
                }
            }, 50); // 20Hz
            
            document.querySelector('button').textContent = 'åœæ­¢è¿½è¸ª';
        }

        // å°è¯•è¿›å…¥VRæ¨¡å¼è¿›è¡ŒçœŸå®æ‰‹éƒ¨è¿½è¸ª
        async function enterVR() {
            try {
                updateStatus('ğŸ”„ æ­£åœ¨å¯åŠ¨VRæ¨¡å¼...');
                
                // æ£€æŸ¥WebXRæ”¯æŒ
                if (!navigator.xr) {
                    throw new Error('æ­¤æµè§ˆå™¨ä¸æ”¯æŒWebXR');
                }
                
                // æ£€æŸ¥æ‰‹éƒ¨è¿½è¸ªæ”¯æŒ
                const supported = await navigator.xr.isSessionSupported('immersive-vr');
                if (!supported) {
                    throw new Error('æ­¤è®¾å¤‡ä¸æ”¯æŒæ²‰æµ¸å¼VR');
                }
                
                // è¿æ¥WebSocket
                connectWebSocket();
                
                // è¯·æ±‚VRä¼šè¯ - å…ˆå°è¯•ä¸è¦æ±‚æ‰‹éƒ¨è¿½è¸ª
                const session = await navigator.xr.requestSession('immersive-vr', {
                    optionalFeatures: ['hand-tracking']
                });
                
                updateStatus('âœ… VRä¼šè¯å¯åŠ¨æˆåŠŸ');
                
                // è®¾ç½®å‚è€ƒç©ºé—´
                const referenceSpace = await session.requestReferenceSpace('local');
                
                // å¼€å§‹æ¸²æŸ“å¾ªç¯
                function onXRFrame(time, frame) {
                    const pose = frame.getViewerPose(referenceSpace);
                    
                    if (pose) {
                        // å°è¯•è·å–æ‰‹éƒ¨è¿½è¸ªæ•°æ®
                        const inputSources = session.inputSources;
                        const handData = {
                            timestamp: time / 1000,
                            leftHand: null,
                            rightHand: null
                        };
                        
                        for (let inputSource of inputSources) {
                            if (inputSource.hand) {
                                const hand = inputSource.hand;
                                const handedness = inputSource.handedness;
                                
                                // è·å–æ‰‹è…•å…³èŠ‚
                                const wristJoint = hand.get('wrist');
                                if (wristJoint) {
                                    const jointPose = frame.getJointPose(wristJoint, referenceSpace);
                                    
                                    if (jointPose) {
                                        const handInfo = {
                                            isTracked: true,
                                            position: {
                                                x: jointPose.transform.position.x,
                                                y: jointPose.transform.position.y,
                                                z: jointPose.transform.position.z
                                            },
                                            rotation: {
                                                x: jointPose.transform.orientation.x,
                                                y: jointPose.transform.orientation.y,
                                                z: jointPose.transform.orientation.z,
                                                w: jointPose.transform.orientation.w
                                            },
                                            pinchStrength: 0 // ç®€åŒ–ç‰ˆæœ¬
                                        };
                                        
                                        if (handedness === 'left') {
                                            handData.leftHand = handInfo;
                                        } else if (handedness === 'right') {
                                            handData.rightHand = handInfo;
                                        }
                                    }
                                }
                            }
                        }
                        
                        // å‘é€çœŸå®æ‰‹éƒ¨è¿½è¸ªæ•°æ®
                        if (websocket && websocket.readyState === WebSocket.OPEN) {
                            websocket.send(JSON.stringify(handData));
                        }
                        
                        // æ›´æ–°æ˜¾ç¤º
                        const leftTracked = handData.leftHand ? 'âœ…' : 'âŒ';
                        const rightTracked = handData.rightHand ? 'âœ…' : 'âŒ';
                        updateData(`VRè¿½è¸ª: å·¦æ‰‹${leftTracked} å³æ‰‹${rightTracked}`);
                    }
                    
                    session.requestAnimationFrame(onXRFrame);
                }
                
                session.requestAnimationFrame(onXRFrame);
                
                // ä¼šè¯ç»“æŸå¤„ç†
                session.onend = function() {
                    updateStatus('VRä¼šè¯å·²ç»“æŸ');
                };
                
            } catch (error) {
                updateStatus('âŒ VRå¯åŠ¨å¤±è´¥: ' + error.message);
                updateData('VRé”™è¯¯: ' + error.message);
                
                // å›é€€åˆ°ç®€å•è¿½è¸ªæ¨¡å¼
                console.log('å›é€€åˆ°ç®€å•è¿½è¸ªæ¨¡å¼');
                startSimpleTracking();
            }
        }

        function stopTracking() {
            isTracking = false;
            if (trackingInterval) {
                clearInterval(trackingInterval);
                trackingInterval = null;
            }
            
            if (websocket) {
                websocket.close();
                websocket = null;
            }
            
            updateStatus('â¹ï¸ è¿½è¸ªå·²åœæ­¢');
            document.querySelector('button').textContent = 'å¼€å§‹ç®€å•è¿½è¸ª';
        }

        function updateStatus(message) {
            document.getElementById('status').textContent = 'çŠ¶æ€: ' + message;
        }

        function updateData(message) {
            const output = document.getElementById('dataOutput');
            const timestamp = new Date().toLocaleTimeString();
            output.innerHTML = `[${timestamp}] ${message}<br>` + output.innerHTML;
            
            // é™åˆ¶æ˜¾ç¤ºè¡Œæ•°
            const lines = output.innerHTML.split('<br>');
            if (lines.length > 15) {
                output.innerHTML = lines.slice(0, 15).join('<br>');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨å°è¯•è¿æ¥
        window.onload = function() {
            updateData('é¡µé¢å·²åŠ è½½ï¼Œå¯ä»¥å¼€å§‹è¿½è¸ª');
            updateData('WebSocketæœåŠ¡å™¨: ws://10.3.32.31:8765');
        };
    </script>
</body>
</html>


