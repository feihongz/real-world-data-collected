<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest Controller Real Data</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #111;
            color: white;
            text-align: center;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        button {
            background: #4CAF50;
            border: none;
            color: white;
            padding: 20px 40px;
            font-size: 18px;
            margin: 10px;
            cursor: pointer;
            border-radius: 10px;
            transition: background-color 0.3s;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .status {
            font-size: 24px;
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
        }
        .connected { background: rgba(0, 255, 0, 0.3); }
        .disconnected { background: rgba(255, 0, 0, 0.3); }
        .data {
            text-align: left;
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 14px;
        }
        .controller-data {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
        }
        .controller {
            flex: 1;
            margin: 0 10px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ® Questæ§åˆ¶å™¨çœŸå®æ•°æ®</h1>
        
        <div id="status" class="status disconnected">
            çŠ¶æ€: æœªè¿æ¥åˆ°æœåŠ¡å™¨
        </div>
        
        <button id="startBtn" onclick="startControllerTracking()">å¼€å§‹æ§åˆ¶å™¨è¿½è¸ª</button>
        <button id="stopBtn" onclick="stopControllerTracking()" disabled>åœæ­¢è¿½è¸ª</button>
        
        <div class="controller-data">
            <div class="controller">
                <h3>ğŸ® å·¦æ§åˆ¶å™¨</h3>
                <div id="leftControllerInfo">ç­‰å¾…æ•°æ®...</div>
            </div>
            <div class="controller">
                <h3>ğŸ® å³æ§åˆ¶å™¨</h3>
                <div id="rightControllerInfo">ç­‰å¾…æ•°æ®...</div>
            </div>
        </div>
        
        <div class="data">
            <h3>ğŸ“¡ æ§åˆ¶å™¨æ•°æ®æµ</h3>
            <div id="dataOutput">ç­‰å¾…è¿æ¥...</div>
        </div>
        
        <div style="margin-top: 30px; font-size: 14px; opacity: 0.8;">
            <p>ğŸ“‹ ä½¿ç”¨è¯´æ˜:</p>
            <ul style="text-align: left; max-width: 600px; margin: 0 auto;">
                <li>æ‹¿èµ·Questæ§åˆ¶å™¨</li>
                <li>ç‚¹å‡»"å¼€å§‹æ§åˆ¶å™¨è¿½è¸ª"</li>
                <li>ç§»åŠ¨å³æ§åˆ¶å™¨æ§åˆ¶æœºæ¢°è‡‚</li>
                <li>æŒ‰ä¸‹æ‰³æœºé”®æ§åˆ¶å¤¹çˆª</li>
            </ul>
        </div>
    </div>

    <script>
        let websocket = null;
        let isTracking = false;
        let animationFrame = null;

        // WebSocketè¿æ¥é…ç½®
        const WEBSOCKET_URL = 'ws://10.3.32.31:8765';

        async function connectWebSocket() {
            try {
                websocket = new WebSocket(WEBSOCKET_URL);
                
                websocket.onopen = function() {
                    updateStatus('å·²è¿æ¥åˆ°æ§åˆ¶æœåŠ¡å™¨', true);
                    updateDataOutput('WebSocketè¿æ¥æˆåŠŸ');
                };
                
                websocket.onclose = function() {
                    updateStatus('ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥', false);
                    updateDataOutput('WebSocketè¿æ¥æ–­å¼€');
                };
                
                websocket.onerror = function(error) {
                    updateStatus('è¿æ¥é”™è¯¯', false);
                    updateDataOutput('WebSocketè¿æ¥é”™è¯¯: ' + error);
                };
                
            } catch (error) {
                updateStatus('WebSocketè¿æ¥å¤±è´¥', false);
                updateDataOutput('è¿æ¥å¤±è´¥: ' + error);
            }
        }

        async function startControllerTracking() {
            try {
                await connectWebSocket();
                
                // æ£€æŸ¥Gamepad APIæ”¯æŒ
                if (!navigator.getGamepads) {
                    throw new Error('æ­¤è®¾å¤‡ä¸æ”¯æŒGamepad API');
                }

                updateStatus('æ§åˆ¶å™¨è¿½è¸ªå·²å¯åŠ¨', true);
                isTracking = true;
                
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;

                // å¼€å§‹è¿½è¸ªå¾ªç¯
                trackControllers();

            } catch (error) {
                updateStatus('å¯åŠ¨å¤±è´¥: ' + error.message, false);
                updateDataOutput('é”™è¯¯: ' + error.message);
            }
        }

        function trackControllers() {
            if (!isTracking) return;

            try {
                const gamepads = navigator.getGamepads();
                const controllerData = {
                    timestamp: Date.now() / 1000,
                    leftHand: null,
                    rightHand: null
                };

                // éå†æ‰€æœ‰æ¸¸æˆæ‰‹æŸ„
                for (let i = 0; i < gamepads.length; i++) {
                    const gamepad = gamepads[i];
                    if (gamepad && gamepad.connected) {
                        
                        // æ£€æŸ¥æ˜¯å¦æ˜¯Questæ§åˆ¶å™¨
                        if (gamepad.id.toLowerCase().includes('oculus') || 
                            gamepad.id.toLowerCase().includes('quest') ||
                            gamepad.id.toLowerCase().includes('meta')) {
                            
                            // è·å–æ§åˆ¶å™¨ä½ç½®å’Œæ—‹è½¬ï¼ˆå¦‚æœæ”¯æŒï¼‰
                            let position = { x: 0, y: 0, z: 0 };
                            let rotation = { x: 0, y: 0, z: 0, w: 1 };
                            
                            // ä»è½´è·å–ä½ç½®ä¿¡æ¯ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
                            if (gamepad.axes.length >= 4) {
                                position.x = gamepad.axes[0] || 0;  // å·¦å³
                                position.y = gamepad.axes[1] || 0;  // ä¸Šä¸‹
                                position.z = gamepad.axes[2] || 0;  // å‰å
                            }
                            
                            // è·å–æŒ‰é’®çŠ¶æ€ä½œä¸ºæåˆå¼ºåº¦
                            let pinchStrength = 0;
                            if (gamepad.buttons.length > 0) {
                                pinchStrength = gamepad.buttons[0].value; // æ‰³æœºé”®
                            }
                            
                            const handData = {
                                isTracked: true,
                                position: position,
                                rotation: rotation,
                                pinchStrength: pinchStrength,
                                controllerIndex: i,
                                controllerId: gamepad.id
                            };
                            
                            // æ ¹æ®æ§åˆ¶å™¨ç´¢å¼•åˆ†é…å·¦å³æ‰‹
                            if (i % 2 === 0) {
                                controllerData.leftHand = handData;
                            } else {
                                controllerData.rightHand = handData;
                            }
                        }
                    }
                }

                // å‘é€æ•°æ®åˆ°æœåŠ¡å™¨
                if (websocket && websocket.readyState === WebSocket.OPEN) {
                    websocket.send(JSON.stringify(controllerData));
                }

                // æ›´æ–°UI
                updateControllerInfo(controllerData);

            } catch (error) {
                updateDataOutput('è¿½è¸ªé”™è¯¯: ' + error.message);
            }

            // ç»§ç»­ä¸‹ä¸€å¸§
            if (isTracking) {
                animationFrame = requestAnimationFrame(trackControllers);
            }
        }

        function stopControllerTracking() {
            isTracking = false;
            
            if (animationFrame) {
                cancelAnimationFrame(animationFrame);
                animationFrame = null;
            }
            
            if (websocket) {
                websocket.close();
                websocket = null;
            }
            
            updateStatus('æ§åˆ¶å™¨è¿½è¸ªå·²åœæ­¢', false);
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
        }

        function updateStatus(message, isConnected) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = 'çŠ¶æ€: ' + message;
            statusEl.className = 'status ' + (isConnected ? 'connected' : 'disconnected');
        }

        function updateDataOutput(message) {
            const outputEl = document.getElementById('dataOutput');
            const timestamp = new Date().toLocaleTimeString();
            outputEl.innerHTML = `[${timestamp}] ${message}<br>` + outputEl.innerHTML;
            
            // é™åˆ¶æ˜¾ç¤ºçš„æ¶ˆæ¯æ•°é‡
            const lines = outputEl.innerHTML.split('<br>');
            if (lines.length > 10) {
                outputEl.innerHTML = lines.slice(0, 10).join('<br>');
            }
        }

        function updateControllerInfo(data) {
            const leftInfo = document.getElementById('leftControllerInfo');
            const rightInfo = document.getElementById('rightControllerInfo');

            if (data.leftHand && data.leftHand.isTracked) {
                const pos = data.leftHand.position;
                const trigger = data.leftHand.pinchStrength;
                leftInfo.innerHTML = `
                    âœ… å·²è¿æ¥<br>
                    æ§åˆ¶å™¨: ${data.leftHand.controllerId}<br>
                    ä½ç½®: (${pos.x.toFixed(3)}, ${pos.y.toFixed(3)}, ${pos.z.toFixed(3)})<br>
                    æ‰³æœº: ${(trigger * 100).toFixed(1)}%
                `;
            } else {
                leftInfo.innerHTML = 'âŒ æœªæ£€æµ‹åˆ°å·¦æ§åˆ¶å™¨';
            }

            if (data.rightHand && data.rightHand.isTracked) {
                const pos = data.rightHand.position;
                const trigger = data.rightHand.pinchStrength;
                rightInfo.innerHTML = `
                    âœ… å·²è¿æ¥<br>
                    æ§åˆ¶å™¨: ${data.rightHand.controllerId}<br>
                    ä½ç½®: (${pos.x.toFixed(3)}, ${pos.y.toFixed(3)}, ${pos.z.toFixed(3)})<br>
                    æ‰³æœº: ${(trigger * 100).toFixed(1)}%
                `;
            } else {
                rightInfo.innerHTML = 'âŒ æœªæ£€æµ‹åˆ°å³æ§åˆ¶å™¨';
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºé…ç½®ä¿¡æ¯
        window.onload = function() {
            updateDataOutput(`WebSocketæœåŠ¡å™¨åœ°å€: ${WEBSOCKET_URL}`);
            updateDataOutput('è¯·ç¡®ä¿Questæ§åˆ¶å™¨å·²å¼€å¯å¹¶è¿æ¥');
        };
    </script>
</body>
</html>


