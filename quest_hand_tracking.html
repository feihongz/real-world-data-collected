<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest Hand Tracking for XArm Control</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
        }
        .status {
            font-size: 24px;
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
        }
        .connected { background: rgba(0, 255, 0, 0.3); }
        .disconnected { background: rgba(255, 0, 0, 0.3); }
        .data {
            text-align: left;
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 14px;
        }
        button {
            background: #4CAF50;
            border: none;
            color: white;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 10px;
            cursor: pointer;
            border-radius: 10px;
            transition: background-color 0.3s;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        .hand-info {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
        }
        .hand {
            flex: 1;
            margin: 0 10px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤– XArmæœºæ¢°è‡‚æ§åˆ¶ - Questæ‰‹éƒ¨è¿½è¸ª</h1>
        
        <div id="status" class="status disconnected">
            çŠ¶æ€: æœªè¿æ¥åˆ°æœåŠ¡å™¨
        </div>
        
        <button id="startBtn" onclick="startHandTracking()">å¼€å§‹æ‰‹éƒ¨è¿½è¸ª</button>
        <button id="stopBtn" onclick="stopHandTracking()" disabled>åœæ­¢è¿½è¸ª</button>
        
        <div class="hand-info">
            <div class="hand">
                <h3>ğŸ‘ˆ å·¦æ‰‹</h3>
                <div id="leftHandInfo">ç­‰å¾…æ•°æ®...</div>
            </div>
            <div class="hand">
                <h3>ğŸ‘‰ å³æ‰‹</h3>
                <div id="rightHandInfo">ç­‰å¾…æ•°æ®...</div>
            </div>
        </div>
        
        <div class="data">
            <h3>ğŸ“¡ å®æ—¶æ•°æ®æµ</h3>
            <div id="dataOutput">ç­‰å¾…è¿æ¥...</div>
        </div>
        
        <div style="margin-top: 30px; font-size: 14px; opacity: 0.8;">
            <p>ğŸ“‹ ä½¿ç”¨è¯´æ˜:</p>
            <ul style="text-align: left; max-width: 600px; margin: 0 auto;">
                <li>ç¡®ä¿Questè®¾å¤‡å’Œæ§åˆ¶ç”µè„‘åœ¨åŒä¸€ç½‘ç»œ</li>
                <li>åœ¨æ§åˆ¶ç”µè„‘ä¸Šè¿è¡ŒWebSocketæœåŠ¡å™¨</li>
                <li>ç‚¹å‡»"å¼€å§‹æ‰‹éƒ¨è¿½è¸ª"æŒ‰é’®</li>
                <li>å…è®¸æ‰‹éƒ¨è¿½è¸ªæƒé™</li>
                <li>å°†æ‰‹æ”¾åœ¨Questæ‘„åƒå¤´è§†é‡å†…</li>
                <li>ä½¿ç”¨æåˆæ‰‹åŠ¿æ§åˆ¶æœºæ¢°è‡‚å¤¹çˆª</li>
            </ul>
        </div>
    </div>

    <script>
        let xrSession = null;
        let websocket = null;
        let animationFrame = null;
        let isTracking = false;

        // WebSocketè¿æ¥é…ç½®
        const WEBSOCKET_URL = 'ws://10.3.32.31:8765';  // ä½ çš„ç”µè„‘IPåœ°å€

        // è·å–ç”µè„‘IPåœ°å€çš„æç¤º
        function showIPInstructions() {
            const currentHost = window.location.hostname;
            if (currentHost !== 'localhost' && currentHost !== '127.0.0.1') {
                // å¦‚æœä»ç½‘ç»œè®¿é—®ï¼Œå°è¯•ä½¿ç”¨å½“å‰ä¸»æœº
                return `ws://${currentHost}:8765`;
            }
            return WEBSOCKET_URL;
        }

        async function connectWebSocket() {
            try {
                const wsUrl = showIPInstructions();
                websocket = new WebSocket(wsUrl);
                
                websocket.onopen = function() {
                    updateStatus('å·²è¿æ¥åˆ°æ§åˆ¶æœåŠ¡å™¨', true);
                    updateDataOutput('WebSocketè¿æ¥æˆåŠŸ');
                };
                
                websocket.onclose = function() {
                    updateStatus('ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥', false);
                    updateDataOutput('WebSocketè¿æ¥æ–­å¼€');
                };
                
                websocket.onerror = function(error) {
                    updateStatus('è¿æ¥é”™è¯¯: ' + error, false);
                    updateDataOutput('WebSocketè¿æ¥é”™è¯¯: ' + error);
                };
                
            } catch (error) {
                updateStatus('WebSocketè¿æ¥å¤±è´¥: ' + error, false);
                updateDataOutput('è¿æ¥å¤±è´¥: ' + error);
            }
        }

        async function startHandTracking() {
            try {
                // è¿æ¥WebSocket
                await connectWebSocket();
                
                // æ£€æŸ¥WebXRæ”¯æŒ
                if (!navigator.xr) {
                    throw new Error('æ­¤è®¾å¤‡ä¸æ”¯æŒWebXR');
                }

                // è¯·æ±‚æ‰‹éƒ¨è¿½è¸ªä¼šè¯
                xrSession = await navigator.xr.requestSession('immersive-vr', {
                    requiredFeatures: ['hand-tracking']
                });

                updateStatus('æ‰‹éƒ¨è¿½è¸ªå·²å¯åŠ¨', true);
                isTracking = true;
                
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;

                // å¼€å§‹è¿½è¸ªå¾ªç¯
                xrSession.requestAnimationFrame(onXRFrame);

            } catch (error) {
                updateStatus('å¯åŠ¨å¤±è´¥: ' + error.message, false);
                updateDataOutput('é”™è¯¯: ' + error.message);
            }
        }

        function stopHandTracking() {
            if (xrSession) {
                xrSession.end();
                xrSession = null;
            }
            
            if (websocket) {
                websocket.close();
                websocket = null;
            }
            
            if (animationFrame) {
                cancelAnimationFrame(animationFrame);
                animationFrame = null;
            }
            
            isTracking = false;
            updateStatus('æ‰‹éƒ¨è¿½è¸ªå·²åœæ­¢', false);
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
        }

        function onXRFrame(time, frame) {
            if (!isTracking) return;

            try {
                // è·å–æ‰‹éƒ¨è¾“å…¥æº
                const inputSources = xrSession.inputSources;
                const handData = {
                    timestamp: time,
                    leftHand: null,
                    rightHand: null
                };

                for (let inputSource of inputSources) {
                    if (inputSource.hand) {
                        const hand = inputSource.hand;
                        const handedness = inputSource.handedness; // 'left' or 'right'
                        
                        // è·å–æ‰‹è…•å…³èŠ‚æ•°æ®
                        if (hand.get('wrist')) {
                            const wristJoint = hand.get('wrist');
                            const pose = frame.getJointPose(wristJoint, xrSession.referenceSpace);
                            
                            if (pose) {
                                const handInfo = {
                                    isTracked: true,
                                    position: {
                                        x: pose.transform.position.x,
                                        y: pose.transform.position.y,
                                        z: pose.transform.position.z
                                    },
                                    rotation: {
                                        x: pose.transform.orientation.x,
                                        y: pose.transform.orientation.y,
                                        z: pose.transform.orientation.z,
                                        w: pose.transform.orientation.w
                                    }
                                };

                                // è®¡ç®—æåˆå¼ºåº¦ (ç®€åŒ–ç‰ˆæœ¬)
                                const thumbTip = hand.get('thumb-tip');
                                const indexTip = hand.get('index-finger-tip');
                                
                                if (thumbTip && indexTip) {
                                    const thumbPose = frame.getJointPose(thumbTip, xrSession.referenceSpace);
                                    const indexPose = frame.getJointPose(indexTip, xrSession.referenceSpace);
                                    
                                    if (thumbPose && indexPose) {
                                        const distance = Math.sqrt(
                                            Math.pow(thumbPose.transform.position.x - indexPose.transform.position.x, 2) +
                                            Math.pow(thumbPose.transform.position.y - indexPose.transform.position.y, 2) +
                                            Math.pow(thumbPose.transform.position.z - indexPose.transform.position.z, 2)
                                        );
                                        
                                        // å°†è·ç¦»è½¬æ¢ä¸ºæåˆå¼ºåº¦ (0-1)
                                        handInfo.pinchStrength = Math.max(0, Math.min(1, 1 - (distance / 0.05)));
                                    }
                                } else {
                                    handInfo.pinchStrength = 0;
                                }

                                if (handedness === 'left') {
                                    handData.leftHand = handInfo;
                                } else if (handedness === 'right') {
                                    handData.rightHand = handInfo;
                                }
                            }
                        }
                    }
                }

                // å‘é€æ•°æ®åˆ°æœåŠ¡å™¨
                if (websocket && websocket.readyState === WebSocket.OPEN) {
                    websocket.send(JSON.stringify(handData));
                }

                // æ›´æ–°UI
                updateHandInfo(handData);

            } catch (error) {
                updateDataOutput('è¿½è¸ªé”™è¯¯: ' + error.message);
            }

            // ç»§ç»­ä¸‹ä¸€å¸§
            if (isTracking) {
                animationFrame = xrSession.requestAnimationFrame(onXRFrame);
            }
        }

        function updateStatus(message, isConnected) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = 'çŠ¶æ€: ' + message;
            statusEl.className = 'status ' + (isConnected ? 'connected' : 'disconnected');
        }

        function updateDataOutput(message) {
            const outputEl = document.getElementById('dataOutput');
            const timestamp = new Date().toLocaleTimeString();
            outputEl.innerHTML = `[${timestamp}] ${message}<br>` + outputEl.innerHTML;
            
            // é™åˆ¶æ˜¾ç¤ºçš„æ¶ˆæ¯æ•°é‡
            const lines = outputEl.innerHTML.split('<br>');
            if (lines.length > 10) {
                outputEl.innerHTML = lines.slice(0, 10).join('<br>');
            }
        }

        function updateHandInfo(handData) {
            const leftInfo = document.getElementById('leftHandInfo');
            const rightInfo = document.getElementById('rightHandInfo');

            if (handData.leftHand && handData.leftHand.isTracked) {
                const pos = handData.leftHand.position;
                const pinch = handData.leftHand.pinchStrength;
                leftInfo.innerHTML = `
                    âœ… è¿½è¸ªä¸­<br>
                    ä½ç½®: (${pos.x.toFixed(3)}, ${pos.y.toFixed(3)}, ${pos.z.toFixed(3)})<br>
                    æåˆå¼ºåº¦: ${(pinch * 100).toFixed(1)}%
                `;
            } else {
                leftInfo.innerHTML = 'âŒ æœªæ£€æµ‹åˆ°';
            }

            if (handData.rightHand && handData.rightHand.isTracked) {
                const pos = handData.rightHand.position;
                const pinch = handData.rightHand.pinchStrength;
                rightInfo.innerHTML = `
                    âœ… è¿½è¸ªä¸­<br>
                    ä½ç½®: (${pos.x.toFixed(3)}, ${pos.y.toFixed(3)}, ${pos.z.toFixed(3)})<br>
                    æåˆå¼ºåº¦: ${(pinch * 100).toFixed(1)}%
                `;
            } else {
                rightInfo.innerHTML = 'âŒ æœªæ£€æµ‹åˆ°';
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºIPé…ç½®ä¿¡æ¯
        window.onload = function() {
            const wsUrl = showIPInstructions();
            updateDataOutput(`WebSocketæœåŠ¡å™¨åœ°å€: ${wsUrl}`);
            updateDataOutput('è¯·ç¡®ä¿åœ¨æ§åˆ¶ç”µè„‘ä¸Šè¿è¡ŒPython WebSocketæœåŠ¡å™¨');
        };
    </script>
</body>
</html>
