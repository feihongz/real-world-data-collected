<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest Touch Control</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #111;
            color: white;
            touch-action: none;
            user-select: none;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .status {
            font-size: 24px;
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            text-align: center;
        }
        .connected { background: rgba(0, 255, 0, 0.3); }
        .disconnected { background: rgba(255, 0, 0, 0.3); }
        
        .control-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .control-area {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }
        
        .touchpad {
            width: 250px;
            height: 250px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid #444;
            border-radius: 15px;
            margin: 10px auto;
            position: relative;
            cursor: pointer;
        }
        
        .touchpad-center {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 10px;
            height: 10px;
            background: #666;
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }
        
        .touch-indicator {
            position: absolute;
            width: 20px;
            height: 20px;
            background: #00ff00;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            display: none;
        }
        
        .gripper-controls {
            margin: 20px 0;
        }
        
        .gripper-btn {
            background: #4CAF50;
            border: none;
            color: white;
            padding: 15px 30px;
            font-size: 18px;
            margin: 10px;
            cursor: pointer;
            border-radius: 10px;
            touch-action: manipulation;
        }
        
        .gripper-btn:active {
            background: #45a049;
            transform: scale(0.95);
        }
        
        .gripper-btn.close {
            background: #f44336;
        }
        
        .position-display {
            font-family: monospace;
            font-size: 16px;
            margin: 10px 0;
            padding: 10px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 5px;
        }
        
        .start-stop {
            text-align: center;
            margin: 20px 0;
        }
        
        .start-stop button {
            background: #2196F3;
            border: none;
            color: white;
            padding: 20px 40px;
            font-size: 20px;
            margin: 10px;
            cursor: pointer;
            border-radius: 15px;
            touch-action: manipulation;
        }
        
        .start-stop button:disabled {
            background: #666;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤– Questè§¦å±æ§åˆ¶</h1>
        
        <div id="status" class="status disconnected">
            çŠ¶æ€: æœªè¿æ¥åˆ°æœåŠ¡å™¨
        </div>
        
        <div class="start-stop">
            <button id="startBtn" onclick="startTouchControl()">å¼€å§‹è§¦å±æ§åˆ¶</button>
            <button id="stopBtn" onclick="stopTouchControl()" disabled>åœæ­¢æ§åˆ¶</button>
        </div>
        
        <div class="control-panel">
            <div class="control-area">
                <h3>ğŸ¯ ä½ç½®æ§åˆ¶ (XYå¹³é¢)</h3>
                <div class="touchpad" id="xyTouchpad">
                    <div class="touchpad-center"></div>
                    <div class="touch-indicator" id="xyIndicator"></div>
                </div>
                <div class="position-display" id="xyDisplay">X: 0.00, Y: 0.00</div>
            </div>
            
            <div class="control-area">
                <h3>â¬†ï¸ é«˜åº¦æ§åˆ¶ (Zè½´)</h3>
                <div class="touchpad" id="zTouchpad">
                    <div class="touchpad-center"></div>
                    <div class="touch-indicator" id="zIndicator"></div>
                </div>
                <div class="position-display" id="zDisplay">Z: 0.00</div>
            </div>
        </div>
        
        <div class="gripper-controls">
            <h3>ğŸ¤ å¤¹çˆªæ§åˆ¶</h3>
            <button class="gripper-btn" onmousedown="setGripper(false)" onmouseup="setGripper(null)" 
                    ontouchstart="setGripper(false)" ontouchend="setGripper(null)">æ‰“å¼€å¤¹çˆª</button>
            <button class="gripper-btn close" onmousedown="setGripper(true)" onmouseup="setGripper(null)"
                    ontouchstart="setGripper(true)" ontouchend="setGripper(null)">å…³é—­å¤¹çˆª</button>
        </div>
        
        <div class="position-display">
            <div id="currentPosition">å½“å‰ä½ç½®: X: 0.35, Y: 0.00, Z: 0.25</div>
        </div>
    </div>

    <script>
        let websocket = null;
        let isControlling = false;
        let currentPosition = { x: 0.35, y: 0.00, z: 0.25 }; // æœºæ¢°è‡‚å·¥ä½œç©ºé—´ä¸­å¿ƒ
        let gripperState = null; // null, true(closed), false(open)
        
        const WEBSOCKET_URL = 'ws://10.3.32.31:8765';
        const POSITION_SCALE = 0.3; // è§¦å±æ˜ å°„åˆ°æœºæ¢°è‡‚çš„ç¼©æ”¾å› å­
        
        async function connectWebSocket() {
            try {
                websocket = new WebSocket(WEBSOCKET_URL);
                
                websocket.onopen = function() {
                    updateStatus('å·²è¿æ¥åˆ°æ§åˆ¶æœåŠ¡å™¨', true);
                };
                
                websocket.onclose = function() {
                    updateStatus('ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥', false);
                };
                
                websocket.onerror = function(error) {
                    updateStatus('è¿æ¥é”™è¯¯', false);
                };
                
            } catch (error) {
                updateStatus('WebSocketè¿æ¥å¤±è´¥', false);
            }
        }
        
        async function startTouchControl() {
            try {
                await connectWebSocket();
                
                isControlling = true;
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                
                setupTouchControls();
                startPositionUpdates();
                
                updateStatus('è§¦å±æ§åˆ¶å·²å¯åŠ¨', true);
                
            } catch (error) {
                updateStatus('å¯åŠ¨å¤±è´¥: ' + error.message, false);
            }
        }
        
        function stopTouchControl() {
            isControlling = false;
            
            if (websocket) {
                websocket.close();
                websocket = null;
            }
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            
            updateStatus('è§¦å±æ§åˆ¶å·²åœæ­¢', false);
        }
        
        function setupTouchControls() {
            const xyTouchpad = document.getElementById('xyTouchpad');
            const zTouchpad = document.getElementById('zTouchpad');
            const xyIndicator = document.getElementById('xyIndicator');
            const zIndicator = document.getElementById('zIndicator');
            
            // XYå¹³é¢æ§åˆ¶
            let xyTouching = false;
            
            function handleXYTouch(event) {
                event.preventDefault();
                const rect = xyTouchpad.getBoundingClientRect();
                const centerX = rect.width / 2;
                const centerY = rect.height / 2;
                
                let clientX, clientY;
                if (event.touches && event.touches.length > 0) {
                    clientX = event.touches[0].clientX;
                    clientY = event.touches[0].clientY;
                } else {
                    clientX = event.clientX;
                    clientY = event.clientY;
                }
                
                const x = clientX - rect.left - centerX;
                const y = clientY - rect.top - centerY;
                
                // é™åˆ¶åœ¨åœ†å½¢åŒºåŸŸå†…
                const distance = Math.sqrt(x * x + y * y);
                const maxDistance = Math.min(centerX, centerY) - 10;
                
                if (distance <= maxDistance) {
                    const normalizedX = x / maxDistance;
                    const normalizedY = -y / maxDistance; // åè½¬Yè½´
                    
                    currentPosition.x = 0.35 + normalizedX * POSITION_SCALE;
                    currentPosition.y = 0.00 + normalizedY * POSITION_SCALE;
                    
                    // æ˜¾ç¤ºè§¦æ‘¸æŒ‡ç¤ºå™¨
                    xyIndicator.style.display = 'block';
                    xyIndicator.style.left = (x + centerX) + 'px';
                    xyIndicator.style.top = (y + centerY) + 'px';
                    
                    updateDisplays();
                }
            }
            
            xyTouchpad.addEventListener('touchstart', function(e) {
                xyTouching = true;
                handleXYTouch(e);
            });
            
            xyTouchpad.addEventListener('touchmove', function(e) {
                if (xyTouching) {
                    handleXYTouch(e);
                }
            });
            
            xyTouchpad.addEventListener('touchend', function(e) {
                xyTouching = false;
                xyIndicator.style.display = 'none';
            });
            
            // é¼ æ ‡äº‹ä»¶æ”¯æŒ
            xyTouchpad.addEventListener('mousedown', function(e) {
                xyTouching = true;
                handleXYTouch(e);
            });
            
            xyTouchpad.addEventListener('mousemove', function(e) {
                if (xyTouching) {
                    handleXYTouch(e);
                }
            });
            
            xyTouchpad.addEventListener('mouseup', function(e) {
                xyTouching = false;
                xyIndicator.style.display = 'none';
            });
            
            // Zè½´æ§åˆ¶
            let zTouching = false;
            
            function handleZTouch(event) {
                event.preventDefault();
                const rect = zTouchpad.getBoundingClientRect();
                const centerY = rect.height / 2;
                
                let clientY;
                if (event.touches && event.touches.length > 0) {
                    clientY = event.touches[0].clientY;
                } else {
                    clientY = event.clientY;
                }
                
                const y = clientY - rect.top - centerY;
                const maxDistance = centerY - 10;
                
                if (Math.abs(y) <= maxDistance) {
                    const normalizedY = -y / maxDistance; // åè½¬Yè½´ï¼Œå‘ä¸Šä¸ºæ­£
                    
                    currentPosition.z = 0.25 + normalizedY * (POSITION_SCALE * 0.5);
                    currentPosition.z = Math.max(0.1, Math.min(0.4, currentPosition.z)); // é™åˆ¶Zè½´èŒƒå›´
                    
                    // æ˜¾ç¤ºè§¦æ‘¸æŒ‡ç¤ºå™¨
                    zIndicator.style.display = 'block';
                    zIndicator.style.left = (rect.width / 2) + 'px';
                    zIndicator.style.top = (y + centerY) + 'px';
                    
                    updateDisplays();
                }
            }
            
            zTouchpad.addEventListener('touchstart', function(e) {
                zTouching = true;
                handleZTouch(e);
            });
            
            zTouchpad.addEventListener('touchmove', function(e) {
                if (zTouching) {
                    handleZTouch(e);
                }
            });
            
            zTouchpad.addEventListener('touchend', function(e) {
                zTouching = false;
                zIndicator.style.display = 'none';
            });
            
            // é¼ æ ‡äº‹ä»¶æ”¯æŒ
            zTouchpad.addEventListener('mousedown', function(e) {
                zTouching = true;
                handleZTouch(e);
            });
            
            zTouchpad.addEventListener('mousemove', function(e) {
                if (zTouching) {
                    handleZTouch(e);
                }
            });
            
            zTouchpad.addEventListener('mouseup', function(e) {
                zTouching = false;
                zIndicator.style.display = 'none';
            });
        }
        
        function setGripper(state) {
            gripperState = state;
            updateDisplays();
        }
        
        function updateDisplays() {
            document.getElementById('xyDisplay').textContent = 
                `X: ${currentPosition.x.toFixed(2)}, Y: ${currentPosition.y.toFixed(2)}`;
            document.getElementById('zDisplay').textContent = 
                `Z: ${currentPosition.z.toFixed(2)}`;
            document.getElementById('currentPosition').textContent = 
                `å½“å‰ä½ç½®: X: ${currentPosition.x.toFixed(2)}, Y: ${currentPosition.y.toFixed(2)}, Z: ${currentPosition.z.toFixed(2)}`;
        }
        
        function startPositionUpdates() {
            function sendUpdate() {
                if (!isControlling) return;
                
                if (websocket && websocket.readyState === WebSocket.OPEN) {
                    const handData = {
                        timestamp: Date.now() / 1000,
                        leftHand: null,
                        rightHand: {
                            isTracked: true,
                            position: {
                                x: currentPosition.x - 0.35, // ç›¸å¯¹äºä¸­å¿ƒç‚¹
                                y: currentPosition.y,
                                z: currentPosition.z - 0.25
                            },
                            rotation: {
                                x: 0, y: 0, z: 0, w: 1
                            },
                            pinchStrength: gripperState === true ? 1.0 : (gripperState === false ? 0.0 : 0.5)
                        }
                    };
                    
                    websocket.send(JSON.stringify(handData));
                }
                
                if (isControlling) {
                    setTimeout(sendUpdate, 50); // 20Hz
                }
            }
            
            sendUpdate();
        }
        
        function updateStatus(message, isConnected) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = 'çŠ¶æ€: ' + message;
            statusEl.className = 'status ' + (isConnected ? 'connected' : 'disconnected');
        }
        
        // åˆå§‹åŒ–æ˜¾ç¤º
        updateDisplays();
    </script>
</body>
</html>


